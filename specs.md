Техническое задание (ТЗ)

Проект: Семейное меню и список покупок (React + Telegram Mini App)

1) Цели и контекст
	•	Снизить бытовой стресс: показывать только актуальную неделю меню (ужины) и актуальный список покупок.
	•	Работать внутри Telegram Mini App (WebApp) и как standalone веб‑страница.
	•	Offline‑first с локальным сохранением отметок и опциональной облачной синхронизацией.
	•	Минимум кликов: открыть → увидеть меню недели → открыть список покупок с чекбоксами → отметить купленное.

2) Основные пользовательские сценарии
	1.	Просмотр текущей недели: Пользователь открывает мини‑апп и видит меню из 7 ужинов (гарнир + мясо/рыба + овощи).
	2.	Список покупок: На вкладке «Покупки» видит агрегированный список ингредиентов на всю неделю, отмечает галочками купленное.
	3.	Переключение недели: При необходимости можно показать «пред/след неделя» (по кнопке/жесту), по умолчанию скрыто.
	4.	Редактирование меню (опционально, v1.1): Изменить блюдо дня (например, заменить гарнир), список покупок пересчитается.
	5.	Сброс отметок: В начале каждой недели отметки «куплено» автоматически сбрасываются; вручную — кнопкой «Сбросить неделю».
	6.	Синхронизация (опционально): Отметки и правки сохраняются в облако и видны супругам.

3) Функциональные требования

3.1 Отображение меню
	•	Показ только текущей недели сразу после загрузки (европейская неделя, пн–вс; TZ: Europe/Budapest).
	•	День карточкой: Название дня, 3 чипа: Гарнир / Белок / Овощи.
	•	Без повторов блюд в течение 4 недель (зафиксированный цикл из 28 ужинов).

3.2 Список покупок
	•	Агрегация ингредиентов по всем блюдам текущей недели.
	•	Группировка по категориям (Мясо/рыба, Гарниры, Овощи/фрукты, Молочка/яйца, Соусы/консервы, Специи/прочее).
	•	Чекбоксы «куплено», прогресс‑бар выполнения, кнопка «Сбросить неделю».
	•	Telegram MainButton: в табе «Покупки» → «Отметить всё купленным» / «Сбросить отметки» (контекстно).

3.3 Навигация и режимы
	•	Две вкладки: Меню | Покупки.
	•	Верхняя панель: «Неделя N (даты)», скрытая навигация «← →» (в настройках).
	•	Темный/светлый режим — авто по Telegram themeParams.

3.4 Редактирование меню (v1.1)
	•	Локальное редактирование блюда в день (выпадающие списки гарниров/белков/овощей из каталога).
	•	Пересчет списка покупок.
	•	Сохранение в localStorage (и в облако при включенной синхронизации).

3.5 Синхронизация (опция)
	•	Авторизация через Telegram initData (Mini Apps). Верификация initData на сервере (см. §9, безопасность).
	•	Хранилище: Supabase/Firebase/PocketBase (выбрать один) для профилей, меню‑правок, чеков списка покупок.
	•	Связка супругов: общий householdId (создание/присоединение по deeplink). Конфликты: last‑write‑wins + optimistic UI.

4) Нефункциональные требования
	•	Performance: LCP < 2.0s на среднем телефоне, bundle < 200KB gz (критически) + code‑splitting.
	•	Offline‑first: localStorage + optional Service Worker для кэша ассетов.
	•	Accessibility: контраст, фокус, ARIA для чекбоксов, динамический размер шрифтов.
	•	i18n: RU/EN (react‑i18next), дефолт RU.
	•	QA: юнит‑тесты (Vitest), e2e (Playwright) базовые.

5) Платформы и интеграции
	•	Telegram Mini Apps (WebApp JS SDK): WebApp.ready(), themeParams, colorSchemeChanged, expand(), viewport, HapticFeedback, MainButton, BackButton, popup.
	•	Standalone Web: та же сборка, фича‑флаг «isTelegram» по наличию window.Telegram?.WebApp.
	•	Дата/время: dayjs + timezone (Europe/Budapest) для расчета ISO недели.

6) Архитектура и стек
	•	Frontend: React 18 + TypeScript + Vite.
	•	Состояние: Zustand (легкий), persist‑middleware (localStorage namespaced по householdId).
	•	UI: TailwindCSS + Headless UI/ Radix (минимум зависимостей).
	•	Иконки: lucide‑react.
	•	i18n: react‑i18next.
	•	Дата/время: dayjs + isoWeek + timezone + utc.
	•	(Опц.) Бэкенд: Supabase (Postgres + Row Level Security) или Firebase (Firestore). Serverless верификация initData.

7) Доменная модель (TS интерфейсы)

export type DayId = 1|2|3|4|5|6|7; // Пн=1 … Вс=7

export interface DishPart { id: string; name: string; note?: string }
export interface Dish { garnish: DishPart; protein: DishPart; veggies: DishPart }

export interface WeekMenu { id: string; title: string; days: Record<DayId, Dish> }

export interface ShoppingItem { id: string; name: string; category: 
  'meat'|'fish'|'grains'|'vegetables'|'fruits'|'dairy_eggs'|'canned'|'sauces'|'spices'|'other';
  qty?: string; // «1 кг», «2 шт», «500 г» (по желанию)
}

export interface HouseholdProfile { id: string; members: string[]; tz: string }

export interface WeekState {
  weekIndex: 0|1|2|3; // тек. неделя в цикле 4-х
  checklist: Record<string, boolean>; // ShoppingItem.id → куплено
  lastResetAt?: string; // ISO
}

8) Бизнес‑правила
	•	Базовый набор меню — 4 фиксированные недели без повторов (см. §16 «Seed‑данные»).
	•	Текущая неделя цикла: index = (isoWeekNumber - baseWeek) mod 4. baseWeek задается в настройках (по умолчанию — неделя публикации).
	•	Сброс чеклистов: авто при смене index или вручную пользователем.
	•	Список покупок = объединение ингредиентов всех 7 блюд недели; дубликаты склеиваются по имени (case‑insensitive). Если указаны qty — суммирование в текстовом виде не требуется в v1 (упрощение).

9) Безопасность и приватность
	•	Mini App auth: initData валидируется на бэкенде (секрет бота). Бэкенд выдает короткий JWT (15 мин) для CRUD в БД.
	•	RLS (Supabase) или Security Rules (Firestore): доступ только к householdId пользователя.
	•	Данные — минимальные (меню, чеклисты). Никаких чувствительных персональных данных.

10) UI/UX
	•	Заголовок: «Неделя N · dd MMM — dd MMM». Кнопка «Меню | Покупки» (tabs).
	•	Карточки дней: Пн … Вс, внутри три чипа: Гарнир / Белок / Овощи. Нажатие → краткая подсказка.
	•	Таб «Покупки»: группы‑аккордеоны по категориям; чекбоксы; счетчик «X из Y» и прогресс‑бар.
	•	Telegram MainButton:
	•	в «Меню»: «Открыть список покупок» → переключает вкладку.
	•	в «Покупки»: «Отметить всё купленным» (если < 100%) / «Сбросить отметки» (если 100%).
	•	HapticFeedback.impactOccurred при отметке/сбросе.
	•	Адаптация тем: используем themeParams для цветов Tailwind (CSS vars).

11) Локальное хранение
	•	Ключи localStorage: famenu:{householdId}:weekState, famenu:{householdId}:overrides.
	•	Миграции схемы: версия в ключе famenu:version.

12) Тестирование
	•	Unit: редьюсеры состояния, агрегация списка покупок, расчет недели.
	•	E2E (Playwright):
	1.	Открытие → текущая неделя видна.
	2.	Переключение в «Покупки» → отметить 3 позиции, перезагрузка → отметки сохранены.
	3.	Смена системной даты → автосброс на новую неделю.

13) Сборка и деплой
	•	CI: GitHub Actions — lint (ESLint), type‑check, test, build.
	•	Хостинг: Vercel/Cloudflare Pages.
	•	Telegram настройка:
	•	Создать бота → /setdomain и Mini App URL.
	•	Добавить WebApp в BotFather (меню, ярлык, размер окна expand()), разрешить инлайн‑запуск.
	•	Включить https (обязательно). CSP: connect-src к выбранному бэкенду.

14) Метрики (опционально)
	•	Plausible/Umami без cookies: просмотры, CTR MainButton, среднее завершение чеклиста.

15) Критерии приемки (v1)
	•	Отображается только текущая неделя по Europe/Budapest, пн–вс.
	•	Меню соответствует seed‑данным цикла из 4 недель, без повторов в месяце.
	•	Список покупок агрегируется по неделе, чекбоксы и прогресс работают и сохраняются локально.
	•	MainButton Telegram меняет текст и действие по контексту вкладки.
	•	Темная/светлая тема берется из WebApp themeParams.
	•	Bundle ≤ 200KB gz (app chunk, без учета полифиллов Telegram), LCP < 2.0s на среднем устройстве.

16) Seed‑данные (цикл из 4 недель)

Неделя 1
	1.	Куриная грудка (гречка, салат огурцы+помидоры)
	2.	Куриные бёдра (пюре, салат из капусты)
	3.	Курица терияки (рис, овощи: перец+брокколи)
	4.	Говяжий фарш (паста, салат свежий)
	5.	Стейк говядины (булгур, запеч. кабачки+перцы)
	6.	Лосось филе (пюре, огурцы)
	7.	Свинина кусочками (запеч. картофель, салат огурцы)

Неделя 2
	1.	Свинина в соевом соусе (паста/лапша, морковь+капуста+перец)
	2.	Шницель свиной (булгур, салат из капусты)
	3.	Скумбрия жареная (булгур, салат из капусты)
	4.	Рыба в кляре (паста, овощи на пару: брокколи+морковь)
	5.	Чили кон карне (рис, зелень)
	6.	Курица с паприкой (булгур, огурцы+зелень)
	7.	Паста с курицей и овощами (сливочно‑томатный)

Неделя 3
	1.	Треска филе (пюре, огурцы)
	2.	Говядина кусочками (булгур, запеч. баклажан+перец+кабачок)
	3.	Куриные крылья (гречка, салат свежий)
	4.	Свинина с луком (рис, салат морковь+капуста)
	5.	Белая рыба на сковороде (гречка, огурцы+зелень)
	6.	Паста с говядиной и овощами (томатный)
	7.	Овощное рагу с курицей (булгур)

Неделя 4
	1.	Лосось/форель (булгур, салат листовой)
	2.	Говяжьи тефтели в томатном (пюре, салат огурцы)
	3.	Свинина тушёная с овощами (гречка)
	4.	Курица в сливочном (паста, салат свежий)
	5.	Хек/скумбрия в духовке (рис, овощи на пару)
	6.	Омлет с овощами и ветчиной/курицей (картофель)
	7.	Овощное рагу с говядиной (булгур)

Примечание: ингредиентный каталог к этим блюдам задается в seedIngredients.ts с маппингом «блюдо → набор ShoppingItem».

17) Каркас компонентов
	•	AppShell: интеграция с Telegram SDK, тема, tabs, MainButton.
	•	WeekHeader: неделя N и даты (пн–вс), кнопки навигации (скрыты по умолчанию).
	•	MenuView: список DayCard × 7.
	•	DayCard: чипы Гарнир/Белок/Овощи, режим просмотра; (v1.1) — редактирование.
	•	ShoppingView: сгруппированный список с чекбоксами и прогрессом.
	•	SettingsSheet: базовая неделя (baseWeek), включить навигацию, включить синхронизацию.

18) Алгоритмы
	•	Определение текущей недели цикла:
	•	isoWeek = dayjs().tz('Europe/Budapest').isoWeek()
	•	index = (isoWeek - baseWeek) % 4 (привести к 0..3 с учетом отрицательных значений)
	•	Агрегация покупок:
	•	Собрать массив ингредиентов 7 блюд, нормализовать имена (lowercase, trim), сгруппировать, отсортировать по category, затем по name.

19) Roadmap
	•	v1.0: Просмотр недели, покупки с чекбоксами, локальное хранение, Telegram MainButton/тема.
	•	v1.1: Редактирование блюд, настройки навигации недель.
	•	v1.2: Облачная синхронизация (householdId, инвайт супруги), серверная валидация initData.
	•	v1.3: Напоминания через Telegram‑бот (еженедельный пинг «закупка»).

20) Вне скоупа (на сейчас)
	•	Точный подсчет количеств ингредиентов (граммовка, рецептуры) — опционально в будущих версиях.
	•	Завтрак/обед/перекусы.
	•	Мультипрофили домохозяйств с правами доступа.
